<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>JS Safe 2.0 - Google CTF | anal.school</title><meta name="description" content="bir çeşit ilim evi"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="JS Safe 2.0 - Google CTF | anal.school"><meta name="twitter:description" content="bir çeşit ilim evi"><meta name="twitter:image" content="https://anal.school/img/twit-banner.webp"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-118381182-2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-118381182-2');</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
 font-display: swap;
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
 font-display: swap;
}</style><meta name="generator" content="Hexo 5.2.0"></head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a><a href="/about/">About</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2018-06-27T11:09:03.000Z" id="date"> 2018-06-27</time></span></div><h1>JS Safe 2.0 - Google CTF</h1><hr></div><div id="post-content"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">You stumbled upon someone&#39;s &quot;JS Safe&quot; on the web. It&#39;s a simple HTML file that can store secrets in the browser&#39;s localStorage. This means that you won&#39;t be able to extract any secret from it (the secrets are on the computer of the owner), but it looks like it was hand-crafted to work only with the password of the owner..<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/CyberSaxosTiGER/CyberSaxosTiGER.github.io/blob/master/files/4dead099e841668a8d86e36fcde8099ce134c195da9863dfb9039043d366942d.zip">Ek</a></p>
<p>Sayfayı incelemeye başlayalım</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keyhole&quot;</span> <span class="hljs-attr">autofocus</span> <span class="hljs-attr">onchange</span>=<span class="hljs-string">&quot;open_safe()&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;🔑&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>id’i <strong>keyhole</strong> olan inputun onchange eventinde <strong>opensafe()</strong> fonksiyonunu çağırdığını görüyoruz. O zaman <strong>opensafe()</strong> fonksiyonuna bakacağız</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open_safe</span>(<span class="hljs-params"></span>) </span>&#123;<br>    keyhole.disabled = <span class="hljs-literal">true</span>;<br>    password = <span class="hljs-regexp">/^CTF&#123;([0-9a-zA-Z_@!?-]+)&#125;$/</span>.exec(keyhole.value);<br>    <span class="hljs-keyword">if</span> (!password || !x(password[<span class="hljs-number">1</span>])) <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.body.className = <span class="hljs-string">&#x27;denied&#x27;</span>;<br>    <span class="hljs-built_in">document</span>.body.className = <span class="hljs-string">&#x27;granted&#x27;</span>;<br>    password = <span class="hljs-built_in">Array</span>.from(password[<span class="hljs-number">1</span>]).map(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.charCodeAt());<br>    encrypted = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">localStorage</span>.content || <span class="hljs-string">&#x27;&#x27;</span>);<br>    content.value = encrypted.map(<span class="hljs-function">(<span class="hljs-params">c, i</span>) =&gt;</span> c ^ password[i % password.length]).map(<span class="hljs-built_in">String</span>.fromCharCode).join(<span class="hljs-string">&#x27;&#x27;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>password</strong> değişkenine <strong>keyhole</strong> içeriğini regex’e göre ayırdığını görüyoruz. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">eğer &#96;CTF&#123;ABC&#125;&#96; girersek<br>&#96;password[0]&#96; &#x3D;&gt;  &#96;CTF&#123;ABC&#125;&#96;<br>&#96;password[1]&#96; &#x3D;&gt;  &#96;ABC&#96;<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (!password || !x(password[<span class="hljs-number">1</span>])) <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.body.className = <span class="hljs-string">&#x27;denied&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>yani şuanlık <strong>opensafe()</strong> fonksiyonunu bırakıp <strong>x()</strong> fonksiyonuna bakacağız</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">x</span>(<span class="hljs-params">х</span>) </span>&#123;<br>    ord = <span class="hljs-built_in">Function</span>.prototype.call.bind(<span class="hljs-string">&#x27;&#x27;</span>.charCodeAt);<br>    chr = <span class="hljs-built_in">String</span>.fromCharCode;<br>    str = <span class="hljs-built_in">String</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">h</span>(<span class="hljs-params">s</span>) </span>&#123;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i != s.length; i++) &#123;<br>            a = ((<span class="hljs-keyword">typeof</span> a == <span class="hljs-string">&#x27;undefined&#x27;</span> ? <span class="hljs-number">1</span> : a) + ord(str(s[i]))) % <span class="hljs-number">65521</span>;<br>            b = ((<span class="hljs-keyword">typeof</span> b == <span class="hljs-string">&#x27;undefined&#x27;</span> ? <span class="hljs-number">0</span> : b) + a) % <span class="hljs-number">65521</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> chr(b &gt;&gt; <span class="hljs-number">8</span>) + chr(b &amp; <span class="hljs-number">0xFF</span>) + chr(a &gt;&gt; <span class="hljs-number">8</span>) + chr(a &amp; <span class="hljs-number">0xFF</span>)<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">c</span>(<span class="hljs-params">a, b, c</span>) </span>&#123;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i != a.length; i++) c = (c || <span class="hljs-string">&#x27;&#x27;</span>) + chr(ord(str(a[i])) ^ ord(str(b[i % b.length])));<br>        <span class="hljs-keyword">return</span> c<br>    &#125;<br>    <span class="hljs-keyword">for</span> (a = <span class="hljs-number">0</span>; a != <span class="hljs-number">1000</span>; a++) <span class="hljs-keyword">debugger</span>;<br>    x = h(str(x));<br>    source = <span class="hljs-regexp">/Ӈ#7ùª9¨M¤À.áÔ¥6¦¨¹.ÿÓÂ.Ö£JºÓ¹WþÊmãÖÚG¤¢dÈ9&amp;òªћ#³­1᧨/</span>;<br>    source.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> c(source, x)<br>    &#125;;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;debug&#x27;</span>, source);<br>        <span class="hljs-keyword">with</span>(source) <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;eval(c(source,x))&#x27;</span>)<br>    &#125; <span class="hljs-keyword">catch</span> (e) &#123;&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>kodu incelemeye başladık ve burada bir anti-debugger konulmuş</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">for</span> (a = <span class="hljs-number">0</span>; a != <span class="hljs-number">1000</span>; a++) <span class="hljs-keyword">debugger</span>;<br></code></pre></td></tr></table></figure>

<p><strong>a=1000</strong> diyip yolumuza devam ediyoruz</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">x = h(str(x));<br></code></pre></td></tr></table></figure>
<p>Diye hileli bir satır var burada. <strong>function x(х)</strong> diye belirtilmiş. <strong>h(str(x))</strong> ve buradaki <strong>x</strong> değişken <strong>x</strong> değil, fonksiyon olan <strong>x</strong> yani <strong>x = h(str(x));</strong> degeri sabit. <strong>x</strong> fonksiyonunu değiştirmeden çalıştırıp <strong>x</strong> değerini çekiyoruz.</p>
<p>Yani x fonksiyonuna paslanan değerin hiçbir önemi yok</p>
<p><strong>x = h(str(x));</strong>‘den sonra <strong>x</strong>‘in son hali <strong>[130,30,10,154]</strong> (unicode olduğu için charcode halini yazdık) <strong>a = 2714</strong> ve <strong>b = 33310</strong> olduğunu gözlemledik.</p>
<p><strong>c</strong> fonksiyonuna <strong>source</strong> değişkenini <strong>x</strong>‘in son halini yolladığımızda </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">c(source,x);<br><br>&#39;х&#x3D;&#x3D;c(\&#39;¢×&amp;Ê´cÊ¯¬$¶³´&#125;ÍÈ´T©Ð8Í³Í|Ô÷aÈÐÝ&amp;¨þJ\&#39;,h(х))&#x2F;&#x2F;᧢&#39;<br></code></pre></td></tr></table></figure>

<p>şifreli textimizi öğrendik</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">c = (c || <span class="hljs-string">&#x27;&#x27;</span>) + chr(ord(str(a[i])) ^ ord(str(b[i % b.length])))<br></code></pre></td></tr></table></figure>

<p>şifreli texti decrypt etmek için <strong>key</strong>‘i bilmemiz gerekiyor. <strong>([0-9a-zA-Z_@!?-]+)</strong> regexine uygun bir şekilde çıktı veren şekilde <strong>xor</strong>‘lamamız gerek.</p>
<p>bildiklerimiz </p>
<ul>
<li>key uzunluğunun 4 hane olması</li>
<li>0-255 arası range olduğu</li>
<li>her 4 cycleda keyin tekrar edeceği</li>
<li>çıktının <strong>([0-9a-zA-Z_@!?-]+)</strong>‘e uygun olacağı</li>
</ul>
<p>yapılacaklar</p>
<ul>
<li>regex’e uygun char listesi oluşturmak</li>
<li>4 defa dönecek bir for</li>
<li>255 defa dönecek diğer bir for</li>
</ul>
<p>eğer key 4 defada bir tekrar ediyorsa her defasında aynı keyi denemeye her 4. karakterde aynı keyi deniyerek false positive oranını düşürürüz</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">encrypted_text = <span class="hljs-string">&#x27;&#x27;</span>.join((<br>    <span class="hljs-number">162</span>, <span class="hljs-number">215</span>, <span class="hljs-number">38</span>, <span class="hljs-number">129</span>, <span class="hljs-number">202</span>, <span class="hljs-number">180</span>, <span class="hljs-number">99</span>, <span class="hljs-number">202</span>, <span class="hljs-number">175</span>, <span class="hljs-number">172</span>, <span class="hljs-number">36</span>, <span class="hljs-number">182</span>, <span class="hljs-number">179</span>, <span class="hljs-number">180</span>, <span class="hljs-number">125</span>, <span class="hljs-number">205</span>, <span class="hljs-number">200</span>, <span class="hljs-number">180</span>, <span class="hljs-number">84</span>, <span class="hljs-number">151</span>, <span class="hljs-number">169</span>, <span class="hljs-number">208</span>, <span class="hljs-number">56</span>, <span class="hljs-number">205</span>, <span class="hljs-number">179</span>, <span class="hljs-number">205</span>, <span class="hljs-number">124</span>, <span class="hljs-number">212</span>, <span class="hljs-number">156</span>, <span class="hljs-number">247</span>, <span class="hljs-number">97</span>, <span class="hljs-number">200</span>, <span class="hljs-number">208</span>, <span class="hljs-number">221</span>, <span class="hljs-number">38</span>, <span class="hljs-number">155</span>, <span class="hljs-number">168</span>, <span class="hljs-number">254</span>, <span class="hljs-number">74</span>,<br>))<br></code></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">valid_char_range = string.ascii_letters + string.digits  + <span class="hljs-string">&#x27;_@!?-&#x27;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    choices = <span class="hljs-built_in">set</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>))<br>    <span class="hljs-keyword">for</span> encrypted_chunk <span class="hljs-keyword">in</span> encrypted_text[i::<span class="hljs-number">4</span>]:<br>        <span class="hljs-keyword">for</span> choice <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>(choices):<br>            metinHal = <span class="hljs-built_in">chr</span>(choice ^ <span class="hljs-built_in">ord</span>(encrypted_chunk))<br>            <span class="hljs-keyword">if</span> metinHal <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> valid_char_range:<br>                choices.remove(choice)<br>    print(<span class="hljs-string">f&quot;Olabilir key <span class="hljs-subst">&#123;i+<span class="hljs-number">1</span>&#125;</span>: <span class="hljs-subst">&#123;choices&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>çıktı ise</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">Olabilir key 1: &#123;253&#125;<br>Olabilir key 2: &#123;149, 153&#125;<br>Olabilir key 3: &#123;21&#125;<br>Olabilir key 4: &#123;249&#125;<br></code></pre></td></tr></table></figure>

<p><strong>c</strong> fonksiyonun sifreli texti ve keyi yolladigimizda</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">&gt; key &#x3D; &#39;&#39;.join((253, 153, 21, 249))<br>&gt; c(encrypted_text, key)<br><br>&#39;_N3x7-v3R51ON-h45-AnTI-4NTi-ant1-D3bUg_&#39;<br></code></pre></td></tr></table></figure>

<p>Ve flag</p>
<p><code>CTF&#123;_N3x7-v3R51ON-h45-AnTI-4NTi-ant1-D3bUg_&#125;</code></p><div id="paginator"></div></div><div id="post-footer"><hr><a href="/2018/06/28/Cat-Chat-Google-CTF/">← Prev Cat-Chat  - Google CTF</a><hr></div><div id="bottom-btn"><a id="to-top" href="#post-title" title="to top">∧</a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/logo.webp" alt="Logo"></a><h1 id="Dr"><a href="/">~nya</a></h1></div><div id="aside-block"></div><footer><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>